# Born2BeRoot

## 仮想マシンの基本的な機能

### 仮想マシンの種類

- ホスト型: VM VirtualBox
- ハイパーバイザー型
- コンテナ型: Docker, Kubernetes

### OS の選択

Devian

### Rocky と Devian の違い

- どちらもLinuxディストリビューション<br>

| 項目 | Rocky Linux | Debian |
| ---- | ---- | ---- |
| ベース | Red Hat Enterprise Linux(RHEL) | 独立 |
| パッケージ管理 | DNF(YUM)/RPM形式 | APT/DEB形式 |
| リリースサイクル | RHELに追従<br>(約5~10年) | 安定版は約2年ごと |
| 主な用途 | 企業向けサーバー、商用環境 | サーバー、デスクトップ、開発環境 |
| 安定性 | 非常に安定、長期サポート | 安定版は非常に安定 |
| 対象ユーザー | 企業、システム管理者 | 初心者から上級者まで幅広い |

#### パッケージ管理システム：DNF/RPM vs APT/DEB

- Rocky Linux: DNFまたはYUMコマンドを使い、.rmpという形式のパッケージを管理
- Debian: APTコマンドを使い、.debという形式のパッケージを管理

#### サポート期間

- Rocky Linux: 最長10年という非常に長いサポート期間
- Debian: 2年ごとにリリース
  -　LTSも提供されておりバランスが取れている

#### ユーザー層

- Rocky Linux: 企業向けサーバーなどに向いている
- Debian: 汎用性に優れ、個人PCから大規模サーバーまで幅広く使える

### 仮想マシンの利点

- 一つの OS で複数の OS や、異なる環境を再現できる
  - 仮想マシンがウイルスに感染したり、設定ミスでOSがクラッシュしたりしても、その影響は仮想マシンの中だけに留まる<br>→システム全体のセキュリティと安定性が飛躍的に向上する
- ハードウェアを抽象化して、リソースを効率的に使用できる
  - 物理ハードウェアだと画面が一つしか使えなかったり、HDD なども規定の個数しか使えなかったりする。また、ネットワークデバイスなどもPCの内部に複数作成できる<br>→物理的な制限に縛られずに色々なことができるようになる

### aptitude と apt の違い

- Debian系Linuxディストリビューションのパッケージ管理コマンド<br>
  - `apt`は日常的な操作のためにシンプルに作られた現在の標準コマンド、`aptitude`はより高機能で、特に複雑な依存関係の解決に強い上級者向けのツール

| 項目 | apt | aptitude |
| ---- | ---- | ---- |
| 主な目的 | 日常的なパッケージ管理を簡単に行う | 高度なパッケージ管理と依存関係の解決 |
| ユーザーインターフェース | シンプルなコマンドライン | コマンドライン+テキストベースの対話型UI |
| 依存関係の解決 | 問題が発生するとエラーで停止することが多い | 複数の解決策を提示し、ユーザーに選択を促す |
| 自動インストールされた<br>パッケージの扱い | `autoremove`で手動削除が必要 | 不要になると自動的に削除を提案・実行する |
| 推奨パッケージの扱い | 非常に安定、長期サポート | 安定版は非常に安定 |
| 標準インストール | ほとんどのシステムで標準 | 標準ではインストールされていない場合がある |

`apt`

- `apt-get`や`apt-cache`といった従来のコマンドの主要な機能を統合し、ユーザーにわかりやすくしたもの

`aptitude`

- テキストベースの対話型UIを備えている

#### 最大の違い：依存関係の解決能力

`apt`

- 依存関係のコンフリクトが発生すると、エラーメッセージを表示して処理を中断する
  - ユーザーは自力で原因を調査し、問題のあるパッケージを特定して対処する必要がある

`aptitude`

- コンフリクトが発生しても、複数の解決策を提示してくれる

#### パッケージの追跡と自動削除

`apt`

- `apt install`でパッケージをインストールした際に自動で追加された依存パッケージは、`sudo apt autoremove`コマンドを別途実行しないと削除されない

`aptitude`

- どのパッケージがユーザーによって明示的にインストールされ、どれが依存関係によって自動的にインストールされたかを記憶しているので、ユーザーが明示的にインストールしたパッケージを削除する際、不要になったパッケージも一緒に削除するかどうかを自動で提案・実行してくれる

### APPArmor

- アプリケーションが強化された操作しかできないように監視するセキュリティシステム
  - Linuxカーネルの機能の一つで、DebianやUbuntuの標準的なセキュリティ機構
- APPArmorには2つの動作モードがある

| 項目 | 動作 | 目的 |
| ---- | ---- | ---- |
| enforce(強制)モード | プロファイルのルールに違反する操作をブロックし、ログに記録する | システムを実際に保護するための本番モード |
| complain(不平)モード | ルール違反をブロックはしないが、「この操作はルール違反ですよ」とログに記録だけする | 新しい新しいルール(プロファイル)を作成したり、テストする際に使用する |

1. APPArmorの状態を確認する
`sudo aa-status` または `sudo apparmor_status`
1. モード切り替え

  - complainモードへ切り替え
  `sudo aa-complain /path/to/program`<br>
  // nginxをcomplainモードにする
  `sudo aa-complain /usr/sbin/nginx`
  - enforceモードへ切り替え
  `sudo aa-enforce /path/to/program`<br>
  // nginxをenforceモードにする
  `sudo aa-enforce /usr/sbin/nginx`

1. APPArmorのプロファイルは、通常`/etc/apparmor.d/`ディレクトリにテキストファイルとして保存されている

---------

### Simple Configlation

- パスワードの確認

```bash
less /etc/pam.d/common-password
```

- UFWの確認

```bash
systemctl status ufw
```

- SSHの確認
  - dはデーモン(daemon)のdらしい

```bash
systemctl status sshd
```

### User

#### 新しいユーザーを作成する

- ルール通りパスワードを割り当てる
- "evaluating"グループを作成し、先ほど作成したユーザーを割り当てる
- 作成したユーザーが実際に"evaluating"グループに属していることを確認する

#### パスワードポリシーの目的

- PCを不正なアクセスから守る
  - パスワードの強度を一定レベルに保ち、サイバー攻撃のリスクを低減させる

|     | 長所 | 短所 |
| ---- | ---- | ---- |
| セキュリティ | セキュリティレベルの向上 | 複雑すぎるルールは、別のリスクを誘発する可能性がある(メモ書き、使い回しなど) |
| 利用者 | セキュリティ基準を満たしやすくなる | 利便性の低下 |

### Hostname and Partitions

- 手順の確認
  1. ログイン名の確認

  ```bash
  whoami
  ```

  2. ホスト名の変更

  ```bash
  sudo hostnamectl set-hostname <login-name>
  ```

  3. `/etc/hosts`ファイルを確認・編集する

  ```bash
  sudo vim /etc/hosts
  ```

  - `127.0.0.1`に関連づけられている古いホスト名を新しいものに置き換える

  4. マシンの再起動

  ```bash
  sudo reboot
  ```

  - プロンプトが新しいホスト名になっていたら成功

  ```bash
  hostname
  ```

- ホスト名を元に戻す

- 仮想マシンのパーティションを表示

```bash
lsblk
```

- `lsblk`の出力が課題のPDFと一致しているか確認
- 通常パートではLVMの使用は必須ではない

#### LVM(Logic Volume Manager)の利点

- 物理的なディスクの制約にとらわれず、ストレージ(ディスク容量)を後から柔軟に変更・管理できる

1. 後から容量を自由に変更できる

- 複数の物理ディスク(またはパーティション)を「仮想的な巨大ディスク(ボリュームグループ)」として束ね、そこから必要なサイズの「仮想的なパーティション(論理ボリューム)」を切り出して使う

  - `/home`の容量が足りなくなったら、ボリュームグループに組み込むだけで、既存の論理ボリュームをさらに拡張できる

  - 新しいハードディスクを追加した場合、そのディスクをボリュームグループに組み込むだけで、既存の論理ボリュームをさらに拡張できる<br>

  これにより、「とりあえず小さめに作っておいて、必要になったら増やす」という運用が可能になり、ディスクスペースを無駄なく使える

2. スナップショット機能

- サーバーを停止させることなく、安全で生合成の取れたバックアップが実現

3. ディスク管理の簡素化

- 複数の物理ディスクを一つの大きなボリュームグループとして扱えるため、管理がシンプルになるkk
  - 1TBのディスク3台を、`/dev/sda`, `/dev/sdb` `/dev/sdc` などのように管理するのではなく、「3TBの巨大なディスクプール」として扱い、そこから必要な分だけ論理ボリュームを切り出すことができる<br>→物理的なディスクの境界を意識する必要がなくなる

### sudo

- `sudo`が実際に仮想マシンにインストールされているか確認

```bash
dpkg -l | grep sudo
```

- 新しいユーザーを`sudo`グループに割り当てる

```bash
sudo usermod -aG sudo <ユーザー名>
```

  - `-a`は「追記(append)」、`-G`は「所属するグループを指定」
  - 変更を反映するには一度ログアウトしてから再ログインする

- sudoの目的と操作
  - 目的: `sudo`の主な目的は、一般ユーザーに、root権限を全て渡すことなく、特定のコマンドのみを管理者として実行させる<br>cf. 最小限の原則
  - 動作: 一般ユーザーが`sudo <コマンド名>` の形式でコマンドを入力
  - 初回実行時、ユーザー自身のパスワードが求められる
  - 認証に成功すると、指定したコマンドがroot権限で実行される
  - どのユーザーが、どのコマンドを`sudo`で実行できるかは、`etc/sudoers`で管理されている
- ルール設定&確認
  - `sudo visudo` コマンドで行う
  - 課題で定められている要件を満たしているか確認
- `/var/log/sudo/`ディレクトリが存在し、少なくとも1つのファイルが含まれていることを確認する
  - sudo経由でコマンドを実行し、ファイルが更新されているかチェック

### UFW(Uncomplicated Firewall)/ファイアウォール

- `UFW`が仮想マシンにインストールされているか確認
- 正しく機能しているか確認

```bash
sudo ufw status verbose
// 機能していない場合
sudo ufw enable
```

- UFWとは
  - Linuxの複雑なファイアウォール機能を簡単に操作するためのツール
  - 許可した通信(ポート)だけを通し、それ以外の不要で危険なアクセスを全てブロックする<br>→不正アクセスやサイバー攻撃からサーバーを守る
- UFWでアクティブなルールをリストする(ポート4242の確認)

```bash
sudo ufw status numbered
```

  - 出力の中に`4242/tcp`に対する`ALLOW IN`のルールがあれば要件を満たしている

- 新しいルールを追加してポート8080を開く
```bash
// ポート8080へのTCP通信を許可
sudo ufw allow 8080/tcp
```

  - アクティブなルールをリストアップして、追加されたことを確認する
  ```bash
  sudo ufw status numbered
  ```

- 新しく追加したルールを削除する
  - `status numbered`で表示された番号を使う
  ```bash
  sudo ufw delete n
  ```
  - 削除されたことの確認
  ```bash
  sudo ufw status numbered
  ```

### SSH

- SSHが仮想マシンにインストールされているか確認
```bash
dpkg -l | grep openssh-server
```

- 正しく機能していることを確認

```bash
sudo systemctl status sshd
```

- SSH(Secure Shell)とは
  - 暗号化された安全な通信路を使い、リモートにあるコンピュータ(サーバー)を遠隔操作するためのプロトコル
  - サーバーを操作する際の通信(入力するパスワードやコマンド、サーバーからの応答)は全て暗号化される。これにより、インターネット経由で安全にサーバーを管理できる
- SSHがポート4242のみを使用していることを確認

```bash
// 待ち受け状態のTCPポートをプロセスとともに表示し、sshdに絞り込む
sudo ss -tlpn | grep sshd
```

- ポート22の行が存在しないことが重要
- この設定は、`/etc/ssh/sshd_config`ファイル内の`Port`ディレクティブを`Port 4242`と書き換えることで実現できる

- 作成された新規ユーザーと接続する
  - `ip a`コマンドなどで確認できる
1. rootユーザーでのログインが拒否されることの確認
`/etc/ssh/sshd_config`ファイル内に`PermitRootLogin no`という設定があるか確認する
- 接続テスト

``` bash
ssh root@<VMのIPアドレス> -p 4242
```

`Permission denied`が出れば成功

1. 新規ユーザーでログインできることの確認
- 接続テスト

```bash
// 別のターミナルから実行
ssh <ユーザー名>@<VMのIPアドレス> -p 4242
```

- `<ユーザー名>` のパスワードを入力し、仮想マシンのシェルにログインできれば成功

### Script Monitoring

- スクリプトの内容の説明
- `cron`とは
  - デーモンの一種。荒火事設定されたスケジュールに従って、指定したコマンドやスクリプトを自動で定期的に実行してくれる。「ジョブスケーラ」とも呼ばれる
  - 設定方法
    - `crontab -e`で設定ファイルを開ける

    ```
    /path/to/monitoring.sh
    ```

- 実行間隔を「毎分」に変更し、動的な値を正しく表示することを確認する
  - 新しいターミナルを開いてログインしたり、`sudo`コマンドを実行したりするなど
- スクリプト自体を変更せずに、サーバー起動時にスクリプトが実行されなくなることを確認する
  - 設定が書かれた行をコメントアウトする
  - サーバーを再起動する

  ```bash
  sudo reboot
  ```

  - スクリプトが同じ場所に存在し、その権限が変更されていないことを確認する

  ```
  ls -l /path/to/monitoring.sh
  ```
